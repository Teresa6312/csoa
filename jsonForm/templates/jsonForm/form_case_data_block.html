{% block content %}
<div id="dynamic-div" class="w3-row">
</div>
    <script>
        // The data passed from Django view
        const section_datas = {{section_datas|safe}}
        // Function to create table header
        function createTableHeader(headerRow, fields) {
            for (const [key, value] of Object.entries(fields)) {
                const th = document.createElement('th');
                th.textContent = value['label']
                headerRow.appendChild(th);
            }
        }

        // Function to create table body
        function createTableBody(tableBody, fields, records) {
            records.forEach(record => {
                const tr = document.createElement('tr');
                for (const [key, value] of Object.entries(fields)) {
                    const td = document.createElement('td');
                    if (key.includes("__") && key.includes("json")) {
                        fiels_keys = splitIfContains(key, "__")
                        if (record[fiels_keys[0]] !== undefined && record[fiels_keys[0]] !== null) {
                            td.textContent = record[fiels_keys[0]][fiels_keys[1]] || '--';  // Default to 'N/A' if value is missing
                        } else {
                            td.textContent =  '--';  // Default to 'N/A' if value is missing
                        }
                    } else if (key.includes("__") && key.includes("link__")) {
                        fiels_keys = splitIfContains(key, "__")
                        var link = document.createElement('a');
                        console.log()
                        link.href = urls[fiels_keys[1]] + record[fiels_keys[2]]; // URL of the link
                        link.textContent = fiels_keys[1]; // Text to display for the link
                        td.appendChild(link);
                    }
                    else {
                        td.textContent = record[key] || '--';  // Default to 'N/A' if value is missing
                    }
                    tr.appendChild(td);
                }
                tableBody.appendChild(tr);
            });
        }
        // Function to create Display Block
        function createDisplayBlock() {
            const parent_div = document.getElementById('dynamic-div');
            const table_block = document.createElement('div');
            section_datas.forEach(record => {
                template = record['form_section__json_template']
                data = record['section_data']
                
                for (const [key, value] of Object.entries(template)) {
                    if (value['input'] !='list' ) {
                        const field_block = document.createElement('div');
                        const field_lable = document.createElement('div');
                        const field_value = document.createElement('div');
                        if (data[key] !=null && data[key]!= '' && data[key] !== undefined){
                            field_value.textContent = data[key]
                        } else{
                            field_value.textContent = '--';
                        }
                        const field_lable_strong = document.createElement('strong');
                        field_lable_strong.textContent = value['label']
                        field_lable.append(field_lable_strong)
                        if (value['helptext'] !=null && value['helptext']!= '' && value['helptext'] !== undefined){
                            field_lable.append(value['helptext'])
                            field_block.classList="w3-container w3-row"
                            field_lable.classList = "w3-large w3-bold w3-padding-small"
                            field_value.classList = "w3-padding-small w3-border"
                        } else {
                            field_block.classList="w3-container w3-half w3-row"
                            field_lable.classList = "w3-large w3-bold w3-padding-small w3-third"
                            field_value.classList = "w3-rest w3-padding-small w3-border"
                        }
                        field_block.append(field_lable)
                        field_block.append(field_value)
                        parent_div.append(field_block)
                    } else {
                        const field_lable = document.createElement('div');
                        field_lable.textContent = value['label'];
                        field_lable.classList = "w3-large w3-bold w3-padding-small w3-margin"
                        table_block.append(field_lable)
                        const field_table = document.createElement('table');
                        field_table.classList = "w3-table  w3-margin"
                        field_table.id = key + '-table'
                        const thead = document.createElement('thead');
                        const head_tr = document.createElement('tr');
                        head_tr.id = key + '-table'+'-head'
                        thead.append(head_tr)
                        field_table.append(thead)
                        
                        createTableHeader(head_tr, value['fields'])
                        const tbody= document.createElement('tbody');
                        tbody.id = key + '-table'+'-body'
                        field_table.append(tbody)
                        console.log(data[key])
                        if (data[key] !== undefined && data[key].length !== 0) {
                            createTableBody(tbody, value['fields'],data[key])
                        } else {
                            const tr = document.createElement('tr');
                            tr.textContent='No data'
                            tbody.appendChild(tr);
                        }
                        table_block.append(field_table)
                    }
                }
            })
            parent_div.append(table_block)
        };
    
        $(document).ready(
            function () {
                createDisplayBlock();
        });
    </script>
{% endblock %}